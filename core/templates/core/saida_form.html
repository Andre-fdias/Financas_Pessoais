{% extends 'core/base.html' %}

{% block title %}{{ action }} Saída Financeira{% endblock %}

{% block extra_head %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
    }
    
    .form-container {
        max-width: 900px;
        margin: 2rem auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        padding: 2.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .dark .form-container {
        background: #1e293b;
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    .form-title {
        font-size: 1.75rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.75rem;
        color: #1f2937;
        letter-spacing: -0.025em;
    }
    
    .dark .form-title {
        color: #f9fafb;
    }
    
    .form-label {
        font-size: 0.9375rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .dark .form-label {
        color: #e5e7eb;
    }
    
    .form-input {
        width: 100%;
        background: #f9fafb;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 0.9375rem;
        color: #1f2937;
        transition: all 0.2s ease;
    }
    
    .dark .form-input {
        background: #334155;
        border-color: #475569;
        color: #f9fafb;
    }
    
    .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        outline: none;
    }
    
    .form-input.invalid {
        border-color: #ef4444;
    }
    
    .form-input.valid {
        border-color: #10b981;
    }
    
    .form-error {
        color: #ef4444;
        font-size: 0.8125rem;
        margin-top: 0.25rem;
    }
    
    .dark .form-error {
        color: #fca5a5;
    }
    
    .form-group {
        margin-bottom: 1.25rem;
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
    }
    
    .form-col {
        flex: 1;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.75rem;
    }
    
    .form-button {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1.75rem;
        font-weight: 500;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .form-button:hover {
        background: #2563eb;
        transform: translateY(-1px);
    }
    
    .cancel-button {
        background: white;
        color: #374151;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.75rem 1.75rem;
        font-weight: 500;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        text-align: center;
    }
    
    .dark .cancel-button {
        background: #1e293b;
        color: #e5e7eb;
        border-color: #475569;
    }
    
    .cancel-button:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
    }
    
    .dark .cancel-button:hover {
        background: #334155;
    }
    
    /* Checkbox styles */
    .checkbox-container {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        background: #f9fafb;
        border: 1.5px solid #e5e7eb;
        transition: all 0.2s ease;
    }
    
    .dark .checkbox-container {
        background: #334155;
        border-color: #475569;
    }
    
    .checkbox-container.checked {
        background: #ecfdf5;
        border-color: #10b981;
    }
    
    .dark .checkbox-container.checked {
        background: #064e3b;
        border-color: #059669;
    }
    
    .checkbox-container input[type="checkbox"] {
        width: auto;
        margin-right: 0.5rem;
        accent-color: #10b981;
    }
    
    /* Modal styles */
    .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
    }
    
    .parcelado-modal {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .dark .parcelado-modal {
        background: #1e293b;
        border: 1px solid #334155;
    }
    
    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        cursor: pointer;
        font-size: 1.5rem;
        color: #6b7280;
    }
    
    .dark .modal-close {
        color: #9ca3af;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-container {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="form-title">{{ action }} Saída Financeira</h1>

    <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="form-group bg-red-50 border-l-4 border-red-500 p-4 dark:bg-red-900/20 dark:border-red-700">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-red-500 dark:text-red-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm text-red-700 dark:text-red-300">
                            {{ form.non_field_errors }}
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="form-group">
            <label for="{{ form.nome.id_for_label }}" class="form-label">
                Descrição <span class="text-red-500">*</span>
            </label>
            {{ form.nome }}
            {% if form.nome.errors %}
                <p class="form-error">{{ form.nome.errors.as_text }}</p>
            {% endif %}
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.tipo_pagamento_detalhe.id_for_label }}" class="form-label">
                        Tipo de Pagamento <span class="text-red-500">*</span>
                    </label>
                    {{ form.tipo_pagamento_detalhe }}
                    {% if form.tipo_pagamento_detalhe.errors %}
                        <p class="form-error">{{ form.tipo_pagamento_detalhe.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group" id="avista_fields" {% if form.tipo_pagamento_detalhe.value == 'parcelado' %}style="display:none"{% endif %}>
                    <label for="{{ form.valor.id_for_label }}" class="form-label">
                        Valor (R$) <span class="text-red-500">*</span>
                    </label>
                    {{ form.valor }}
                    {% if form.valor.errors %}
                        <p class="form-error">{{ form.valor.errors.as_text }}</p>
                    {% endif %}
                </div>
                <div class="form-group" id="parcelado_btn" style="display:none;">
                    <button type="button" class="form-button" onclick="showParceladoModal()" style="width:100%; margin-top:1.7rem;">
                        Configurar Parcelamento
                    </button>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.data_vencimento.id_for_label }}" class="form-label">
                        Data de Vencimento <span class="text-red-500">*</span>
                    </label>
                    {{ form.data_vencimento }}
                    {% if form.data_vencimento.errors %}
                        <p class="form-error">{{ form.data_vencimento.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.valor_parcela.id_for_label }}" class="form-label">
                        Valor da Parcela
                    </label>
                    {{ form.valor_parcela }}
                    {% if form.valor_parcela.errors %}
                        <p class="form-error">{{ form.valor_parcela.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.quantidade_parcelas.id_for_label }}" class="form-label">
                        Número de Parcelas
                    </label>
                    {{ form.quantidade_parcelas }}
                    {% if form.quantidade_parcelas.errors %}
                        <p class="form-error">{{ form.quantidade_parcelas.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.data_lancamento.id_for_label }}" class="form-label">
                        Data do Lançamento <span class="text-red-500">*</span>
                    </label>
                    {{ form.data_lancamento }}
                    {% if form.data_lancamento.errors %}
                        <p class="form-error">{{ form.data_lancamento.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.local.id_for_label }}" class="form-label">
                        Local
                    </label>
                    {{ form.local }}
                    {% if form.local.errors %}
                        <p class="form-error">{{ form.local.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.categoria.id_for_label }}" class="form-label">
                        Categoria <span class="text-red-500">*</span>
                    </label>
                    {{ form.categoria }}
                    {% if form.categoria.errors %}
                        <p class="form-error">{{ form.categoria.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.subcategoria.id_for_label }}" class="form-label">
                        Subcategoria
                    </label>
                    <select id="{{ form.subcategoria.id_for_label }}" name="{{ form.subcategoria.html_name }}" class="form-input">
                        <option value="">---------</option>
                        {% for subcategoria in subcategorias %}
                            <option value="{{ subcategoria.id }}" {% if form.subcategoria.value == subcategoria.id %}selected{% endif %}>
                                {{ subcategoria.nome }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.subcategoria.errors %}
                        <p class="form-error">{{ form.subcategoria.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.forma_pagamento.id_for_label }}" class="form-label">
                        Forma de Pagamento <span class="text-red-500">*</span>
                    </label>
                    {{ form.forma_pagamento }}
                    {% if form.forma_pagamento.errors %}
                        <p class="form-error">{{ form.forma_pagamento.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.recorrente.id_for_label }}" class="form-label">
                        Recorrência <span class="text-red-500">*</span>
                    </label>
                    {{ form.recorrente }}
                    {% if form.recorrente.errors %}
                        <p class="form-error">{{ form.recorrente.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="{{ form.conta_bancaria.id_for_label }}" class="form-label">
                        Conta Bancária <span class="text-red-500">*</span>
                    </label>
                    {{ form.conta_bancaria }}
                    {% if form.conta_bancaria.errors %}
                        <p class="form-error">{{ form.conta_bancaria.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <div id="situacao-container" class="checkbox-container {% if form.situacao.value == 'pago' %}checked{% endif %}">
                        <input type="checkbox" id="{{ form.situacao.id_for_label }}" name="{{ form.situacao.html_name }}" 
                            value="pago" {% if form.situacao.value == 'pago' %}checked{% endif %} />
                        <label for="{{ form.situacao.id_for_label }}" class="form-label">
                            Marcar como Pago
                        </label>
                    </div>
                    <p class="text-sm text-gray-500">Deixe desmarcado para contas a pagar no futuro</p>
                    {% if form.situacao.errors %}
                        <p class="form-error">{{ form.situacao.errors.as_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.observacao.id_for_label }}" class="form-label">
                Observações
            </label>
            {{ form.observacao }}
            {% if form.observacao.errors %}
                <p class="form-error">{{ form.observacao.errors.as_text }}</p>
            {% endif %}
        </div>

        <div class="form-actions">
            <a href="{% url 'core:saida_list' %}" class="cancel-button">
                Cancelar
            </a>
            <button type="submit" class="form-button">
                {{ action }} Saída
            </button>
        </div>
    </form>
</div>

<!-- Modal de Parcelamento -->
<div id="parcelado_modal_bg" class="modal-bg">
    <div class="parcelado-modal">
        <span class="modal-close" onclick="hideParceladoModal()">×</span>
        <h3>Configurar Parcelamento</h3>
        
        <div class="form-group">
            <fieldset>
                <legend class="form-label">Como deseja preencher?</legend>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label class="checkbox-container">
                        <input type="radio" name="metodo_parcelamento" value="valor_total" checked onclick="chooseMetodoParcelado('total')" />
                        Valor total
                    </label>
                    <label class="checkbox-container">
                        <input type="radio" name="metodo_parcelamento" value="valor_parcela" onclick="chooseMetodoParcelado('parcela')" />
                        Valor da parcela
                    </label>
                </div>
            </fieldset>
        </div>

        <div id="parcelamento_por_total">
            <div class="form-group">
                <label for="parcelado_valor" class="form-label">Valor total (R$)</label>
                <input type="number" step="0.01" id="parcelado_valor" name="parcelado_valor" class="form-input" />
                <span id="parcelado_valor_error" class="form-error"></span>
            </div>
            
            <div class="form-group">
                <label for="parcelado_num_parcelas" class="form-label">Parcelas</label>
                <select id="parcelado_num_parcelas" name="parcelado_num_parcelas" class="form-input">
                    {% for i in parcelas_choices %}
                        <option value="{{ i }}">{{ i }} parcela{{ i|pluralize }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="parcelamento_por_parcela" style="display:none;">
            <div class="form-group">
                <label for="parcelado_valor_parcela" class="form-label">Valor da parcela (R$)</label>
                <input type="number" step="0.01" id="parcelado_valor_parcela" name="parcelado_valor_parcela" class="form-input" />
                <span id="parcelado_valor_parcela_error" class="form-error"></span>
            </div>
            
            <div class="form-group">
                <label for="parcelado_num_parcelas_2" class="form-label">Parcelas</label>
                <select id="parcelado_num_parcelas_2" name="parcelado_num_parcelas_2" class="form-input">
                    {% for i in parcelas_choices %}
                        <option value="{{ i }}">{{ i }} parcela{{ i|pluralize }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Valor total calculado (R$)</label>
                <input type="text" id="parcelado_total_calc" class="form-input" readonly />
            </div>
        </div>

        <div class="form-actions" style="margin-top: 1.5rem;">
            <button type="button" class="cancel-button" onclick="hideParceladoModal()">
                Cancelar
            </button>
            <button type="button" class="form-button" onclick="confirmParcelado()">
                Confirmar
            </button>
        </div>
    </div>
</div>

<script>
    // Funções do modal de parcelamento
    function showParceladoModal() {
        document.getElementById('parcelado_modal_bg').style.display = 'flex';
    }
    
    function hideParceladoModal() {
        document.getElementById('parcelado_modal_bg').style.display = 'none';
    }
    
    function chooseMetodoParcelado(metodo) {
        if (metodo === 'total') {
            document.getElementById('parcelamento_por_total').style.display = 'block';
            document.getElementById('parcelamento_por_parcela').style.display = 'none';
        } else {
            document.getElementById('parcelamento_por_total').style.display = 'none';
            document.getElementById('parcelamento_por_parcela').style.display = 'block';
        }
    }
    
    // Cálculos de parcelamento
    document.getElementById('parcelado_valor')?.addEventListener('input', function() {
        let total = parseFloat(this.value) || 0;
        let parcelas = parseInt(document.getElementById('parcelado_num_parcelas').value) || 1;
        document.getElementById('parcelado_valor_parcela').value = (total / parcelas).toFixed(2);
    });
    
    document.getElementById('parcelado_num_parcelas')?.addEventListener('change', function() {
        let total = parseFloat(document.getElementById('parcelado_valor').value) || 0;
        let parcelas = parseInt(this.value) || 1;
        document.getElementById('parcelado_valor_parcela').value = (total / parcelas).toFixed(2);
    });
    
    document.getElementById('parcelado_valor_parcela')?.addEventListener('input', function() {
        let parcela = parseFloat(this.value) || 0;
        let parcelas = parseInt(document.getElementById('parcelado_num_parcelas_2').value) || 1;
        document.getElementById('parcelado_total_calc').value = (parcela * parcelas).toFixed(2);
    });
    
    document.getElementById('parcelado_num_parcelas_2')?.addEventListener('change', function() {
        let parcela = parseFloat(document.getElementById('parcelado_valor_parcela').value) || 0;
        let parcelas = parseInt(this.value) || 1;
        document.getElementById('parcelado_total_calc').value = (parcela * parcelas).toFixed(2);
    });
    
    function confirmParcelado() {
        if (document.getElementById('parcelamento_por_total').style.display !== 'none') {
            let total = document.getElementById('parcelado_valor').value || '0';
            let parcelas = document.getElementById('parcelado_num_parcelas').value || '1';
            document.getElementById('id_valor').value = total;
            document.getElementById('id_quantidade_parcelas').value = parcelas;
            document.getElementById('id_valor_parcela').value = (parseFloat(total) / parseInt(parcelas)).toFixed(2);
        } else {
            let parcela = document.getElementById('parcelado_valor_parcela').value || '0';
            let parcelas = document.getElementById('parcelado_num_parcelas_2').value || '1';
            document.getElementById('id_valor_parcela').value = parcela;
            document.getElementById('id_quantidade_parcelas').value = parcelas;
            document.getElementById('id_valor').value = (parseFloat(parcela) * parseInt(parcelas)).toFixed(2);
        }
        hideParceladoModal();
    }
    
    // Alternar entre pagamento à vista e parcelado
    document.getElementById('id_tipo_pagamento_detalhe')?.addEventListener('change', function() {
        if (this.value === 'parcelado') {
            document.getElementById('avista_fields').style.display = 'none';
            document.getElementById('parcelado_btn').style.display = 'block';
        } else {
            document.getElementById('avista_fields').style.display = 'block';
            document.getElementById('parcelado_btn').style.display = 'none';
        }
    });
    
    // Controle do checkbox de situação (pago/pendente)
    const situacaoCheckbox = document.getElementById('{{ form.situacao.id_for_label }}');
    const situacaoContainer = document.getElementById('situacao-container');
    
    if (situacaoCheckbox) {
        situacaoCheckbox.addEventListener('change', function() {
            if (this.checked) {
                situacaoContainer.classList.add('checked');
            } else {
                situacaoContainer.classList.remove('checked');
            }
        });
    }

    function atualizarValoresParcelamento() {
    const tipoPagamento = document.getElementById('id_tipo_pagamento_detalhe').value;
    const valorTotal = parseFloat(document.getElementById('id_valor').value) || 0;
    const parcelas = parseInt(document.getElementById('id_quantidade_parcelas').value) || 1;
    
    if (tipoPagamento === 'parcelado') {
        const valorParcela = valorTotal / parcelas;
        document.getElementById('id_valor_parcela').value = valorParcela.toFixed(2);
    } else {
        document.getElementById('id_valor_parcela').value = valorTotal.toFixed(2);
        document.getElementById('id_quantidade_parcelas').value = 1;
    }
}

// Adicione listeners para os campos relevantes
document.getElementById('id_tipo_pagamento_detalhe').addEventListener('change', atualizarValoresParcelamento);
document.getElementById('id_valor').addEventListener('input', atualizarValoresParcelamento);
document.getElementById('id_quantidade_parcelas').addEventListener('change', atualizarValoresParcelamento);
    
    // Carregar subcategorias dinamicamente
    document.getElementById('{{ form.categoria.id_for_label }}')?.addEventListener('change', function() {
        const categoriaId = this.value;
        const subcategoriaSelect = document.getElementById('{{ form.subcategoria.id_for_label }}');
        
        if (categoriaId) {
            fetch(`/get-subcategorias/?categoria=${categoriaId}`)
                .then(response => response.json())
                .then(data => {
                    // Limpa as opções atuais
                    subcategoriaSelect.innerHTML = '<option value="">---------</option>';
                    
                    // Adiciona as novas opções
                    data.forEach(subcategoria => {
                        const option = document.createElement('option');
                        option.value = subcategoria.id;
                        option.textContent = subcategoria.nome;
                        subcategoriaSelect.appendChild(option);
                    });
                });
        } else {
            subcategoriaSelect.innerHTML = '<option value="">---------</option>';
        }
    });
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // Configuração inicial dos campos de parcelamento
        let tipoPagamento = document.getElementById('id_tipo_pagamento_detalhe');
        if (tipoPagamento && tipoPagamento.value === 'parcelado') {
            document.getElementById('avista_fields').style.display = 'none';
            document.getElementById('parcelado_btn').style.display = 'block';
        }
        
        // Adiciona classes aos inputs do formulário
        document.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.classList.contains('form-input') && el.type !== 'checkbox' && el.type !== 'radio') {
                el.classList.add('form-input');
            }
        });
        
        // Validação em tempo real
        document.querySelectorAll('input[required], select[required]').forEach(el => {
            el.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.add('invalid');
                    this.classList.remove('valid');
                }
            });
        });
        
    // Limitar datas futuras
    const dataVencimentoInput = document.getElementById('id_data_vencimento');
    const dataLancamentoInput = document.getElementById('id_data_lancamento');

    if (dataVencimentoInput) {
        // Permite datas futuras para vencimento (para contas a pagar)
        dataVencimentoInput.setAttribute('min', new Date().toISOString().split('T')[0]);
    }

    if (dataLancamentoInput) {
        // Data de lançamento não pode ser futura
        const today = new Date().toISOString().split('T')[0];
        dataLancamentoInput.setAttribute('max', today);
    }
        
        // Disparar evento de change para categoria se já houver valor selecionado
        const categoriaSelect = document.getElementById('{{ form.categoria.id_for_label }}');
        if (categoriaSelect && categoriaSelect.value) {
            categoriaSelect.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}