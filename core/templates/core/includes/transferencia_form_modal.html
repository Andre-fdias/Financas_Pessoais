{% load widget_tweaks %}

<div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
    <div class="form-container w-full max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Nova Transferência</h2>
            <button type="button" class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <form method="post" id="transfer-form-modal" action="{% url 'core:transferencia_create' %}" class="space-y-6">
            {% csrf_token %}
            
            <!-- Conta de Origem -->
            <div class="input-group">
                <label for="{{ form.conta_origem.id_for_label }}" class="form-label flex items-center dark:text-white">
                    <i class="fas fa-arrow-up mr-2 text-red-500"></i>
                    Conta de Origem
                </label>
                <div class="relative">
                    {{ form.conta_origem|add_class:"form-input dark:bg-gray-700 dark:text-white dark:border-gray-600" }}
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div id="saldo-origem-display" class="mt-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                    Selecione uma conta para ver o saldo disponível.
                </div>
                <p class="form-error hidden text-red-500 text-sm mt-1" id="conta_origem_error"></p>
            </div>

            <!-- Conta de Destino -->
            <div class="input-group">
                <label for="{{ form.conta_destino.id_for_label }}" class="form-label flex items-center dark:text-white">
                    <i class="fas fa-arrow-down mr-2 text-green-500"></i>
                    Conta de Destino
                </label>
                <div class="relative">
                    {{ form.conta_destino|add_class:"form-input dark:bg-gray-700 dark:text-white dark:border-gray-600" }}
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <p class="form-error hidden text-red-500 text-sm mt-1" id="conta_destino_error"></p>
            </div>

            <!-- Valor - SEM VALIDAÇÃO -->
            <div class="input-group">
                <label for="id_valor" class="form-label flex items-center dark:text-white">
                    <i class="fas fa-money-bill-wave mr-2 text-purple-500"></i>
                    Valor da Transferência
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500 dark:text-gray-400">R$</span>
                    </div>
                    <input type="text" id="id_valor" name="valor" 
                           class="form-input pl-12 dark:bg-gray-700 dark:text-white dark:border-gray-600" 
                           placeholder="0,00" 
                           inputmode="decimal">
                </div>
                <p class="form-error hidden text-red-500 text-sm mt-1" id="valor_error"></p>
            </div>

            <!-- Descrição -->
            <div class="input-group">
                <label for="id_descricao" class="form-label flex items-center dark:text-white">
                    <i class="fas fa-pencil-alt mr-2 text-gray-500"></i>
                    Descrição
                </label>
                <input type="text" id="id_descricao" name="descricao" 
                       class="form-input dark:bg-gray-700 dark:text-white dark:border-gray-600" 
                       placeholder="Descrição da transferência (opcional)">
                <p class="form-error hidden text-red-500 text-sm mt-1" id="descricao_error"></p>
            </div>

            <!-- Mensagens de erro não associadas a campos específicos -->
            <div id="non-field-errors" class="hidden bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700 dark:text-red-300" id="non-field-errors-text"></p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" class="cancel-btn px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 flex items-center transition-all hover:shadow-md close-modal">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                </button>
                <button type="submit" class="submit-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg inline-flex items-center">
                    <i class="fas fa-exchange-alt mr-2"></i>
                    Realizar Transferência
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Função simplificada para formatar moeda
function formatarMoeda(input) {
    if (!input) return;
    
    // Remove tudo que não é dígito, exceto vírgula
    let valor = input.value.replace(/[^\d,]/g, '');
    
    // Garante que há apenas uma vírgula
    const partes = valor.split(',');
    if (partes.length > 2) {
        valor = partes[0] + ',' + partes.slice(1).join('');
    }
    
    // Se estiver vazio, define como zero
    if (valor === '') {
        input.value = '0,00';
        return;
    }
    
    // Separa parte inteira e decimal
    let parteInteira = partes[0] || '0';
    let parteDecimal = partes[1] || '00';
    
    // Remove zeros à esquerda da parte inteira
    parteInteira = parteInteira.replace(/^0+/, '');
    if (parteInteira === '') parteInteira = '0';
    
    // Limita a parte decimal a 2 dígitos
    if (parteDecimal.length > 2) {
        parteDecimal = parteDecimal.substring(0, 2);
    }
    
    // Formata os reais com separadores de milhar
    const formattedReais = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Atualiza o valor do campo
    input.value = formattedReais + (partes.length > 1 ? ',' + parteDecimal : ',00');
}

// Função para converter valor formatado para número
function parseMoeda(valorFormatado) {
    if (!valorFormatado) return 0;
    
    // Remove pontos de milhar e substitui vírgula por ponto
    const valorNumerico = valorFormatado.replace(/\./g, '').replace(',', '.');
    
    // Converte para número
    const valor = parseFloat(valorNumerico);
    
    return isNaN(valor) ? 0 : valor;
}

// Inicialização quando o modal é carregado
document.addEventListener('DOMContentLoaded', function() {
    const valorInput = document.querySelector('#id_valor');
    
    if (valorInput) {
        // Formatar valor inicial
        if (!valorInput.value) {
            valorInput.value = '0,00';
        } else {
            formatarMoeda(valorInput);
        }
        
        // Formatar durante a digitação
        valorInput.addEventListener('input', function() {
            formatarMoeda(this);
        });
        
        // Formatar ao perder o foco
        valorInput.addEventListener('blur', function() {
            formatarMoeda(this);
        });
        
        // Selecionar todo o texto ao focar
        valorInput.addEventListener('focus', function() {
            this.select();
        });
    }
    
    // Adicionar campo hidden com valor numérico antes do envio
    const transferForm = document.getElementById('transfer-form-modal');
    if (transferForm) {
        transferForm.addEventListener('submit', function(e) {
            if (valorInput) {
                const valorNumerico = parseMoeda(valorInput.value);
                
                // Remover campo hidden anterior se existir
                const existingHidden = document.querySelector('input[name="valor_numerico"]');
                if (existingHidden) {
                    existingHidden.remove();
                }
                
                // Criar um campo hidden com o valor numérico
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'valor_numerico';
                hiddenInput.value = valorNumerico;
                this.appendChild(hiddenInput);
                
                console.log('Valor numérico enviado:', valorNumerico);
            }
        });
    }
});
</script>