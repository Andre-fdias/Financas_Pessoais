{% extends 'core/base.html' %}
{% load currency_filters %}

{% block title %}Dashboard Financeiro{% endblock %}

{% block extra_head %}
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos base do painel e outros elementos */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #ece9e6, #ffffff); /* Fundo suave */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        @supports not (backdrop-filter: blur(16px)) {
            .glass-panel {
                background-color: rgba(255, 255, 255, 0.9);
            }
        }
        
        .chart-container {
            height: 300px; /* Altura fixa para todos os containers de gráficos */
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .valor-positivo {
            background-color: #f0fdf4;
            color: #166534;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        
        .valor-negativo {
            background-color: #fef2f2;
            color: #b91c1c;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .dark .valor-positivo {
            background-color: #052e16;
            color: #bbf7d0;
        }
        
        .dark .valor-negativo {
            background-color: #450a0a;
            color: #fca5a5;
        }

        .table-striped tbody tr:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8 flex-grow">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Dashboard Financeiro</h1>
        
        <!-- Filtro de Período (simulado) -->
        <div class="flex justify-end mb-6">
            <label for="periodo-select" class="sr-only">Filtrar por Período</label>
            <select id="periodo-select" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 px-4 py-2">
                <option value="30">Últimos 30 dias</option>
                <option value="90">Últimos 90 dias</option>
                <option value="365">Últimos 365 dias</option>
                <option value="custom">Período Personalizado</option>
            </select>
        </div>

        <!-- Cards de dados principais -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Saldo Geral -->
            <div class="glass-panel p-6 shadow-md rounded-lg text-gray-800 dark:text-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xl font-semibold">Saldo Geral</span>
                    <i class="fas fa-balance-scale text-3xl text-blue-500"></i>
                </div>
                <p id="saldoGeral" class="mt-2 text-4xl font-extrabold"></p>
                <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                    <i class="fas fa-info-circle"></i>
                    <span class="ml-1">Período selecionado</span>
                </div>
            </div>

            <!-- Receitas do Mês -->
            <div class="glass-panel p-6 shadow-md rounded-lg text-gray-800 dark:text-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xl font-semibold">Receitas do Mês</span>
                    <i class="fas fa-arrow-up text-3xl text-green-500"></i>
                </div>
                <p id="entradasMes" class="mt-2 text-4xl font-extrabold text-green-600"></p>
                <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                    <span id="variacaoReceitas" class="font-medium"></span> vs mês anterior
                </div>
            </div>

            <!-- Despesas do Mês -->
            <div class="glass-panel p-6 shadow-md rounded-lg text-gray-800 dark:text-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xl font-semibold">Despesas do Mês</span>
                    <i class="fas fa-arrow-down text-3xl text-red-500"></i>
                </div>
                <p id="saidasMes" class="mt-2 text-4xl font-extrabold text-red-600"></p>
                <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                    <span id="variacaoDespesas" class="font-medium"></span> vs mês anterior
                </div>
            </div>

            <!-- Saldo em Poupanças (Reserva de Emergência Simples) -->
            <div class="glass-panel p-6 shadow-md rounded-lg text-gray-800 dark:text-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xl font-semibold">Reserva de Emergência</span>
                    <i class="fas fa-shield-alt text-3xl text-purple-500"></i>
                </div>
                <p id="saldoPoupancas" class="mt-2 text-4xl font-extrabold"></p>
                <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                    <i class="fas fa-target"></i>
                    <span id="metaReserva" class="ml-1"></span>
                </div>
            </div>
        </div>

        <!-- Gráficos Principais -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gráfico de Receitas vs Despesas Mensais -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Receitas vs Despesas Mensais</h2>
                <div class="chart-container">
                    <canvas id="transacoesMensaisChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Saldo Acumulado -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Saldo Acumulado</h2>
                <div class="chart-container">
                    <canvas id="saldoAcumuladoChart"></canvas>
                </div>
            </div>
            
            <!-- Gráfico de Sazonalidade -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Análise de Sazonalidade</h2>
                <div class="chart-container">
                    <canvas id="sazonalidadeChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Projeção Futura -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Projeção Futura de Saldo</h2>
                <div class="chart-container">
                    <canvas id="projecaoSaldoChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Despesas por Categoria -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Despesas por Categoria</h2>
                <div class="chart-container">
                    <canvas id="saidasCategoriaChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Receitas por Categoria -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Receitas por Categoria</h2>
                <div class="chart-container">
                    <canvas id="entradasCategoriaChart"></canvas>
                </div>
            </div>
            
            <!-- Gráfico de Saldos por Conta -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Saldos por Conta Bancária</h2>
                <div class="chart-container">
                    <canvas id="saldoContasChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Despesas Fixas vs Variáveis -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Despesas Fixas vs Variáveis</h2>
                <div class="chart-container">
                    <canvas id="despesasFixasVariaveisChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Status de Pagamentos -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Status de Pagamentos</h2>
                <div class="chart-container">
                    <canvas id="statusPagamentosChart"></canvas>
                </div>
            </div>
            
            <!-- Gráfico de Alocação de Investimentos -->
            <div class="glass-panel p-6 shadow-md rounded-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Sugestão de Alocação de Investimentos</h2>
                <div class="chart-container">
                    <canvas id="alocacaoInvestimentosChart"></canvas>
                </div>
                <p id="sugestaoInvestimentos" class="mt-4 text-sm text-gray-600 italic text-center">
                    <strong>Sugestão:</strong> Foque em construir reserva de emergência primeiro.
                </p>
            </div>
        </div>

        <!-- Seção de Reserva de Emergência Detalhada -->
        <div class="glass-panel p-6 mt-4 mb-8 shadow-md rounded-lg text-gray-800 dark:text-gray-200">
            <div class="flex items-center justify-between mb-4">
                <span class="text-xl font-semibold">Reserva de Emergência</span>
                <i class="fas fa-shield-alt text-3xl text-purple-500"></i>
            </div>
            
            <!-- Seletor de Meses da Meta -->
            <div class="mb-8 p-3 bg-purple-50 dark:bg-purple-900 rounded-lg w-full md:w-2/4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-sliders-h mr-1"></i>Meses de despesa para meta:
                </label>
                <select id="meses-meta-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="3">3 meses</option>
                    <option value="6" selected>6 meses</option>
                    <option value="9">9 meses</option>
                    <option value="12">12 meses</option>
                </select>
                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                    Quantos meses de despesa você quer como reserva?
                </div>
            </div>
            
            <!-- Meta Ideal -->
            <div class="mb-3 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium" id="meta-ideal-label">Meta Ideal (6 meses):</span>
                    <span id="reservaEmergenciaIdeal" class="text-lg font-bold text-blue-600"></span>
                </div>
                <div class="text-xs text-gray-600">
                    Média: <span id="despesaMensalMedia"></span>/mês
                </div>
            </div>
            
            <!-- Saldo Atual em Poupanças -->
            <div class="mb-3 p-3 bg-green-50 dark:bg-green-900 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium">Saldo em Poupanças:</span>
                    <span id="saldoAtualPoupancas" class="text-lg font-bold"></span>
                </div>
            </div>
            
            <!-- Diferença -->
            <div class="mb-3 p-3 rounded-lg" id="diferencaReservaPanel">
                <div class="flex justify-between items-center">
                    <span id="diferencaLabel" class="text-sm font-medium"></span>
                    <span id="valorFaltante" class="text-lg font-bold"></span>
                </div>
            </div>
            
            <!-- Barra de Progresso -->
            <div class="mb-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium">Progresso:</span>
                    <span id="percentualAtingido" class="text-sm font-bold"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                    <div id="progressBar" class="h-2 rounded-full"></div>
                </div>
            </div>
            
            <!-- Projeção de Tempo -->
            <div id="projecaoTempoPanel" class="mb-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="text-center">
                    <span class="text-sm font-medium">
                        <i class="fas fa-clock mr-1"></i>Previsão para atingir:
                    </span>
                    <div id="tempoProjecao" class="mt-1 text-md font-bold"></div>
                    <div class="text-xs text-gray-600 mt-1">
                        Baseado na sua despesa mensal média
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div id="statusReservaPanel" class="text-center p-2 rounded-lg">
                <i id="statusIcon" class="fas mr-1"></i>
                <span id="statusTexto" class="font-semibold"></span>
            </div>
        </div>

        <!-- Indicadores de Saúde Financeira -->
        <div class="glass-panel p-6 shadow-md rounded-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Indicadores de Saúde Financeira</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div>
                    <h3 class="font-semibold text-lg">Liquidez Corrente</h3>
                    <p class="text-3xl font-bold text-blue-600" id="liquidezCorrente">0%</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Margem de Segurança</h3>
                    <p class="text-3xl font-bold text-green-600" id="margemSeguranca">0%</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Endividamento</h3>
                    <p class="text-3xl font-bold text-red-600" id="endividamento">0%</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Poupança Mensal Estimada</h3>
                    <p class="text-3xl font-bold text-purple-600" id="poupancaMensal">R$ 0,00</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Reserva de Emergência Ideal</h3>
                    <p class="text-3xl font-bold text-orange-600" id="reservaEmergenciaIdealIndicador">R$ 0,00</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Nível de Risco</h3>
                    <p class="text-3xl font-bold text-yellow-600" id="nivelRisco">Baixo</p>
                </div>
            </div>
        </div>

        <!-- Análise Comportamental -->
        <div class="glass-panel p-6 shadow-md rounded-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Análise Comportamental</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold text-xl mb-2">Gastos por Dia da Semana</h3>
                    <div class="chart-container">
                        <canvas id="gastosPorDiaChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-xl mb-2">Gastos por Tipo (Comportamental)</h3>
                    <div class="chart-container">
                        <canvas id="categoriasComportamentoChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-xl mb-2">Gastos por Hora do Dia</h3>
                    <div class="chart-container">
                        <canvas id="gastosPorHoraChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulações de Cenários -->
        <div class="glass-panel p-6 shadow-md rounded-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Simulações de Cenários</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="font-semibold">Aumento de 10% nas Despesas:</h4>
                    <p class="text-lg" id="aumentoDespesas">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="font-semibold">Redução de 10% nas Despesas:</h4>
                    <p class="text-lg" id="reducaoDespesas">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="font-semibold">Aumento de 10% nas Receitas:</h4>
                    <p class="text-lg" id="aumentoReceitas">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="font-semibold">Redução de 10% nas Receitas:</h4>
                    <p class="text-lg" id="reducaoReceitas">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow">
                    <h4 class="font-semibold">Impacto da Inflação (5%):</h4>
                    <p class="text-lg" id="impactoInflacao">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- Análise de Riscos -->
        <div class="glass-panel p-6 shadow-md rounded-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Análise de Riscos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                <div>
                    <h3 class="font-semibold text-lg">Concentração de Risco de Renda</h3>
                    <p class="text-3xl font-bold text-red-600" id="concentracaoRisco">0%</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">Reserva de Emergência Coberta</h3>
                    <p class="text-3xl font-bold text-green-600" id="reservaIdealCoberta">R$ 0,00 / R$ 0,00</p>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-600 italic text-center">
                O nível de risco da sua renda é <strong id="nivelRiscoTexto">Baixo</strong>.
            </p>
        </div>

        <!-- Últimas Transações -->
        <div class="glass-panel p-6 shadow-md rounded-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Últimas Transações</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden table-striped">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Data</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Descrição</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Valor</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Tipo</th>
                        </tr>
                    </thead>
                    <tbody id="ultimasTransacoesTable">
                        <!-- Conteúdo preenchido dinamicamente pelo JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Dados reais do contexto Django
            // O '|escapejs' é crucial para garantir que a string JSON seja segura para o JavaScript
            const contextData = JSON.parse('{{ dados_graficos_json|escapejs }}');

            // Funções para formatar moeda e porcentagem
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }

            function formatPercent(value) {
                return `${value.toFixed(1)}%`;
            }

            // ===== PREENCHIMENTO DOS CARDS PRINCIPAIS =====
            document.getElementById('saldoGeral').textContent = formatCurrency(contextData.saldo_geral);
            // Verifica se o elemento tem a classe para evitar erros antes de adicionar
            const saldoGeralEl = document.getElementById('saldoGeral');
            if (saldoGeralEl) {
                if (contextData.saldo_geral >= 0) {
                    saldoGeralEl.classList.add('text-green-600');
                    saldoGeralEl.classList.remove('text-red-600');
                } else {
                    saldoGeralEl.classList.add('text-red-600');
                    saldoGeralEl.classList.remove('text-green-600');
                }
            }


            document.getElementById('entradasMes').textContent = formatCurrency(contextData.entradas_mes);
            const variacaoReceitasEl = document.getElementById('variacaoReceitas');
            variacaoReceitasEl.textContent = `${contextData.variacao_receitas >= 0 ? '+' : ''}${formatPercent(contextData.variacao_receitas)}`;
            variacaoReceitasEl.className = 'font-medium ' + (contextData.variacao_receitas >= 0 ? 'text-green-600' : 'text-red-600');

            document.getElementById('saidasMes').textContent = formatCurrency(contextData.saidas_mes);
            const variacaoDespesasEl = document.getElementById('variacaoDespesas');
            variacaoDespesasEl.textContent = `${contextData.variacao_despesas >= 0 ? '+' : ''}${formatPercent(contextData.variacao_despesas)}`;
            variacaoDespesasEl.className = 'font-medium ' + (contextData.variacao_despesas <= 0 ? 'text-green-600' : 'text-red-600');
            
            // Renderiza a seção detalhada da Reserva de Emergência e o card resumido
            function renderReservaEmergencia(mesesMeta = contextData.meses_meta) {
                const despesaMensalMedia = contextData.despesa_mensal_media;
                const saldoPoupancas = contextData.saldo_poupancas;
                const reservaEmergenciaIdeal = despesaMensalMedia * mesesMeta;
                const valorFaltante = Math.max(0, reservaEmergenciaIdeal - saldoPoupancas);
                const percentualAtingido = Math.min((saldoPoupancas / reservaEmergenciaIdeal * 100), 100) || 0;

                // Card resumido
                const saldoPoupancasEl = document.getElementById('saldoPoupancas');
                saldoPoupancasEl.textContent = formatCurrency(saldoPoupancas);
                saldoPoupancasEl.className = `mt-2 text-4xl font-extrabold ${saldoPoupancas >= reservaEmergenciaIdeal ? 'text-green-600' : 'text-yellow-600'}`;
                document.getElementById('metaReserva').textContent = `Meta: ${mesesMeta} meses (${formatCurrency(reservaEmergenciaIdeal)})`;

                // Detalhado
                document.getElementById('meses-meta-select').value = mesesMeta;
                document.getElementById('meta-ideal-label').textContent = `Meta Ideal (${mesesMeta} meses):`;
                document.getElementById('reservaEmergenciaIdeal').textContent = formatCurrency(reservaEmergenciaIdeal);
                document.getElementById('despesaMensalMedia').textContent = formatCurrency(despesaMensalMedia);
                document.getElementById('saldoAtualPoupancas').textContent = formatCurrency(saldoPoupancas);
                document.getElementById('saldoAtualPoupancas').className = `text-lg font-bold ${saldoPoupancas >= reservaEmergenciaIdeal ? 'text-green-600' : 'text-yellow-600'}`;

                const diferencaLabel = document.getElementById('diferencaLabel');
                const valorFaltanteEl = document.getElementById('valorFaltante');
                const diferencaPanel = document.getElementById('diferencaReservaPanel');

                if (valorFaltante > 0) {
                    diferencaLabel.textContent = 'Falta:';
                    valorFaltanteEl.textContent = `- ${formatCurrency(valorFaltante)}`;
                    valorFaltanteEl.className = 'text-lg font-bold text-yellow-600';
                    diferencaPanel.className = 'mb-3 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg';
                    document.getElementById('projecaoTempoPanel').style.display = 'block';

                    // Simulação simples de tempo para atingir a meta
                    // Adicionando uma verificação para evitar divisão por zero
                    let tempoProjecaoText = 'N/A';
                    if ((contextData.entradas_mes - contextData.saidas_mes) > 0) {
                        const mesesParaAtingir = valorFaltante / (contextData.entradas_mes - contextData.saidas_mes);
                        tempoProjecaoText = `${Math.ceil(mesesParaAtingir)} meses`;
                    }
                    document.getElementById('tempoProjecao').textContent = tempoProjecaoText;
                    
                } else {
                    diferencaLabel.textContent = 'Excedente:';
                    valorFaltanteEl.textContent = `+ ${formatCurrency(Math.abs(valorFaltante))}`;
                    valorFaltanteEl.className = 'text-lg font-bold text-green-600';
                    diferencaPanel.className = 'mb-3 p-3 bg-green-50 dark:bg-green-900 rounded-lg';
                    document.getElementById('projecaoTempoPanel').style.display = 'none';
                }

                document.getElementById('percentualAtingido').textContent = formatPercent(percentualAtingido);
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = `${percentualAtingido}%`;
                progressBar.className = `h-2 rounded-full ${percentualAtingido >= 100 ? 'bg-green-500' : 'bg-blue-500'}`;
                document.getElementById('percentualAtingido').className = `text-sm font-bold ${percentualAtingido >= 100 ? 'text-green-600' : 'text-blue-600'}`;

                const statusReservaPanel = document.getElementById('statusReservaPanel');
                const statusIcon = document.getElementById('statusIcon');
                const statusTexto = document.getElementById('statusTexto');
                if (percentualAtingido >= 100) {
                    statusReservaPanel.className = 'text-center p-2 rounded-lg bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-200';
                    statusIcon.className = 'fas fa-check-circle mr-1';
                    statusTexto.textContent = `Meta de ${mesesMeta} meses atingida!`;
                } else {
                    statusReservaPanel.className = 'text-center p-2 rounded-lg bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-200';
                    statusIcon.className = 'fas fa-running mr-1';
                    statusTexto.textContent = `${percentualAtingido.toFixed(1)}% conquistado`;
                }
            }

            renderReservaEmergencia(contextData.meses_meta);

            // Listener para o seletor de meses da meta de reserva
            document.getElementById('meses-meta-select').addEventListener('change', function() {
                renderReservaEmergencia(parseInt(this.value));
            });

            // ===== INDICADORES DE SAÚDE FINANCEIRA =====
            document.getElementById('liquidezCorrente').textContent = formatPercent(contextData.indicadores.liquidez_corrente);
            document.getElementById('margemSeguranca').textContent = formatPercent(contextData.indicadores.margem_seguranca);
            document.getElementById('endividamento').textContent = formatPercent(contextData.indicadores.endividamento);
            document.getElementById('poupancaMensal').textContent = formatCurrency(contextData.indicadores.poupanca_mensal);
            document.getElementById('reservaEmergenciaIdealIndicador').textContent = formatCurrency(contextData.indicadores.reserva_emergencia_ideal);
            document.getElementById('nivelRisco').textContent = contextData.analise_riscos.nivel_risco;

            // ===== SIMULAÇÕES DE CENÁRIOS =====
            document.getElementById('aumentoDespesas').textContent = formatCurrency(contextData.simulacoes.aumento_10_despesas);
            document.getElementById('reducaoDespesas').textContent = formatCurrency(contextData.simulacoes.reducao_10_despesas);
            document.getElementById('aumentoReceitas').textContent = formatCurrency(contextData.simulacoes.aumento_10_receitas);
            document.getElementById('reducaoReceitas').textContent = formatCurrency(contextData.simulacoes.reducao_10_receitas);
            document.getElementById('impactoInflacao').textContent = formatCurrency(contextData.simulacoes.impacto_inflacao_5);

            // ===== ANÁLISE DE RISCOS =====
            document.getElementById('concentracaoRisco').textContent = formatPercent(contextData.analise_riscos.concentracao_risco);
            document.getElementById('reservaIdealCoberta').textContent = 
                `${formatCurrency(contextData.saldo_poupancas)} / ${formatCurrency(contextData.analise_riscos.reserva_ideal)}`;
            document.getElementById('nivelRiscoTexto').textContent = contextData.analise_riscos.nivel_risco;
            document.getElementById('sugestaoInvestimentos').textContent = contextData.otimizacao_investimentos.sugestao;

            // ===== CONFIGURAÇÃO COMUM DOS GRÁFICOS =====
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label || context.label}: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            };

            // ===== GRÁFICO 1: RECEITAS VS DESPESAS MENSAIS =====
            new Chart(document.getElementById('transacoesMensaisChart'), {
                type: 'bar',
                data: {
                    labels: contextData.meses_labels,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: contextData.receitas_mensais_data,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderRadius: 5
                        },
                        {
                            label: 'Despesas',
                            data: contextData.despesas_mensais_data,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderRadius: 5
                        }
                    ]
                },
                options: chartOptions
            });

            // ===== GRÁFICO 2: SALDO ACUMULADO =====
            new Chart(document.getElementById('saldoAcumuladoChart'), {
                type: 'line',
                data: {
                    labels: contextData.meses_labels,
                    datasets: [{
                        label: 'Saldo Acumulado',
                        data: contextData.saldo_acumulado_data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // ===== GRÁFICO 3: SAZONALIDADE =====
            new Chart(document.getElementById('sazonalidadeChart'), {
                type: 'line',
                data: {
                    labels: contextData.sazonalidade_labels,
                    datasets: [{
                        label: 'Saldo Líquido Mensal',
                        data: contextData.sazonalidade_values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });

            // ===== GRÁFICO 4: PROJEÇÃO FUTURA =====
            new Chart(document.getElementById('projecaoSaldoChart'), {
                type: 'line',
                data: {
                    labels: contextData.projecao_labels,
                    datasets: [
                        {
                            label: 'Projeção Receitas',
                            data: contextData.projecao_receitas,
                            borderColor: '#22c55e',
                            borderDash: [5, 5],
                            tension: 0.3,
                            tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${formatCurrency(context.raw)}`; } } }
                        },
                        {
                            label: 'Projeção Despesas',
                            data: contextData.projecao_despesas,
                            borderColor: '#ef4444',
                            borderDash: [5, 5],
                            tension: 0.3,
                            tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${formatCurrency(context.raw)}`; } } }
                        },
                        {
                            label: 'Projeção Saldo',
                            data: contextData.projecao_saldo,
                            borderColor: '#3b82f6',
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${formatCurrency(context.raw)}`; } } }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 5: DESPESAS POR CATEGORIA =====
            new Chart(document.getElementById('saidasCategoriaChart'), {
                type: 'doughnut',
                data: {
                    labels: contextData.categorias_despesas_labels,
                    datasets: [{
                        data: contextData.categorias_despesas_data,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#a855f7',
                            '#6b7280', '#dc2626', '#d946ef', '#fbbf24', '#2dd4bf', '#a3e635'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 6: RECEITAS POR CATEGORIA (ou Forma de Recebimento) =====
            new Chart(document.getElementById('entradasCategoriaChart'), {
                type: 'pie',
                data: {
                    labels: contextData.categorias_receitas_labels,
                    datasets: [{
                        data: contextData.categorias_receitas_values,
                        backgroundColor: [
                            '#22c55e', '#3b82f6', '#f59e0b', '#10b981', '#6b7280', '#d946ef'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 7: SALDOS POR CONTA BANCÁRIA =====
            new Chart(document.getElementById('saldoContasChart'), {
                type: 'bar',
                data: {
                    labels: contextData.saldo_contas_labels,
                    datasets: [{
                        label: 'Saldo',
                        data: contextData.saldo_contas_values,
                        backgroundColor: contextData.saldo_contas_values.map(value => value >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderRadius: 5
                    }]
                },
                options: chartOptions
            });

            // ===== GRÁFICO 8: DESPESAS FIXAS VS VARIÁVEIS =====
            new Chart(document.getElementById('despesasFixasVariaveisChart'), {
                type: 'pie',
                data: {
                    labels: ['Despesas Fixas', 'Despesas Variáveis'],
                    datasets: [{
                        data: [contextData.despesas_fixas, contextData.despesas_variaveis],
                        backgroundColor: ['#a855f7', '#fcd34d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 9: STATUS DE PAGAMENTOS =====
            new Chart(document.getElementById('statusPagamentosChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes'],
                    datasets: [{
                        data: [contextData.pagos_total, contextData.pendentes_total],
                        backgroundColor: ['#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 10: GASTOS POR DIA DA SEMANA (ANÁLISE COMPORTAMENTAL) =====
            const gastosPorDiaLabels = Object.keys(contextData.analise_comportamental.gastos_por_dia);
            const gastosPorDiaValues = Object.values(contextData.analise_comportamental.gastos_por_dia);
            
            new Chart(document.getElementById('gastosPorDiaChart'), {
                type: 'bar',
                data: {
                    labels: gastosPorDiaLabels,
                    datasets: [{
                        label: 'Gastos por Dia',
                        data: gastosPorDiaValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 5
                    }]
                },
                options: chartOptions
            });

            // ===== GRÁFICO 11: CATEGORIAS COMPORTAMENTAIS (ANÁLISE COMPORTAMENTAL) =====
            const catComportamentoLabels = Object.keys(contextData.analise_comportamental.categorias_comportamento);
            const catComportamentoValues = Object.values(contextData.analise_comportamental.categorias_comportamento);
            
            new Chart(document.getElementById('categoriasComportamentoChart'), {
                type: 'doughnut',
                data: {
                    labels: catComportamentoLabels,
                    datasets: [{
                        data: catComportamentoValues,
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 12: GASTOS POR HORA DO DIA (ANÁLISE COMPORTAMENTAL) =====
            const gastosPorHoraLabels = Object.keys(contextData.analise_comportamental.gastos_por_hora_dia);
            const gastosPorHoraValues = Object.values(contextData.analise_comportamental.gastos_por_hora_dia);
            
            new Chart(document.getElementById('gastosPorHoraChart'), {
                type: 'bar',
                data: {
                    labels: gastosPorHoraLabels,
                    datasets: [{
                        label: 'Gastos por Hora',
                        data: gastosPorHoraValues,
                        backgroundColor: 'rgba(236, 72, 153, 0.8)', // Cor rosa
                        borderRadius: 5
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora do Dia'
                            }
                        }
                    }
                }
            });

            // ===== GRÁFICO 13: ALOCAÇÃO DE INVESTIMENTOS =====
            new Chart(document.getElementById('alocacaoInvestimentosChart'), {
                type: 'doughnut',
                data: {
                    labels: contextData.otimizacao_investimentos.alocacao_labels,
                    datasets: [{
                        data: contextData.otimizacao_investimentos.alocacao_values,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });

            console.log('✅ Todos os gráficos foram criados com sucesso!');
            
            // Filtro de período
            document.getElementById('periodo-select').addEventListener('change', function() {
                const periodo = this.value;
                if (periodo === 'custom') {
                    alert('Selecione as datas no calendário (funcionalidade em desenvolvimento).');
                } else {
                    console.log(`Período selecionado: ${periodo} dias.`);
                    // Para atualizar os dados dinamicamente, você precisaria de uma chamada AJAX
                    // fetch(`/dashboard/?periodo=${periodo}`).then(response => response.json()).then(newData => { /* Atualizar gráficos */ });
                    // Por simplicidade, para este exemplo, a página precisaria ser recarregada ou ter uma lógica AJAX mais robusta
                }
            });

            // ===== PREENCHIMENTO DA TABELA DE ÚLTIMAS TRANSAÇÕES =====
            const ultimasTransacoesTableBody = document.getElementById('ultimasTransacoesTable');
            ultimasTransacoesTableBody.innerHTML = '';

            // As datas já vêm como ISO string e são ordenadas corretamente
            contextData.ultimas_transacoes.forEach(transacao => {
                const row = document.createElement('tr');
                const valorClass = transacao.valor >= 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-700">${new Date(transacao.data).toLocaleDateString('pt-BR')}</td>
                    <td class="py-3 px-4 text-gray-700">${transacao.descricao}</td>
                    <td class="py-3 px-4 ${valorClass} font-semibold">${formatCurrency(transacao.valor)}</td>
                    <td class="py-3 px-4 ${valorClass} font-semibold">${transacao.tipo}</td>
                `;
                ultimasTransacoesTableBody.appendChild(row);
            });
        });
    </script>
{% endblock %}
