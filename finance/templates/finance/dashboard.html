{% extends 'finance/base.html' %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Saldo Total -->
    <div class="col-md-4 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Saldo Total</h5>
                <h2 class="card-text">R$ {{ total_balance|floatformat:2|intcomma }}</h2>
                <p class="card-text">Disponível em todas as contas</p>
            </div>
        </div>
    </div>

    <!-- Cartões de Crédito -->
    <div class="col-md-4 mb-4">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title">Cartões de Crédito</h5>
                <h2 class="card-text">R$ {{ total_credit_used|floatformat:2|intcomma }}</h2>
                <p class="card-text">Utilizado de R$ {{ total_credit_limit|floatformat:2|intcomma }}</p>
            </div>
        </div>
    </div>

    <!-- Próximas Despesas -->
    <div class="col-md-4 mb-4">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title">Próximas Despesas</h5>
                <h2 class="card-text">R$ 0,00</h2>
                <p class="card-text">Nos próximos 7 dias</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Contas Bancárias -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Contas Bancárias</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Conta</th>
                                <th class="text-end">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in accounts %}
                            <tr>
                                <td>{{ account }}</td>
                                <td class="text-end">R$ {{ account.current_balance|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center">Nenhuma conta cadastrada</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="{% url 'finance:bank_account_list' %}" class="btn btn-outline-primary btn-sm">Ver todas</a>
                <a href="{% url 'finance:bank_account_create' %}" class="btn btn-primary btn-sm">Nova Conta</a>
            </div>
        </div>
    </div>

    <!-- Cartões de Crédito -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Cartões de Crédito</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Cartão</th>
                                <th class="text-end">Utilizado</th>
                                <th class="text-end">Disponível</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for card in credit_cards %}
                            <tr>
                                <td>{{ card }}</td>
                                <td class="text-end">R$ {{ card.current_balance|floatformat:2|intcomma }}</td>
                                <td class="text-end">R$ {{ card.available_limit|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">Nenhum cartão cadastrado</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="{% url 'finance:credit_card_list' %}" class="btn btn-outline-primary btn-sm">Ver todos</a>
                <a href="{% url 'finance:credit_card_create' %}" class="btn btn-primary btn-sm">Novo Cartão</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Últimas Transações -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Últimas Transações</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>{{ transaction.date|date:"d/m/Y" }}</td>
                                <td>{{ transaction.description|truncatechars:30 }}</td>
                                <td class="text-end {% if transaction.transaction_type == 'IN' %}text-success{% else %}text-danger{% endif %}">
                                    R$ {{ transaction.amount|floatformat:2|intcomma }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">Nenhuma transação registrada</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="{% url 'finance:transaction_list' %}" class="btn btn-outline-primary btn-sm">Ver extrato completo</a>
                <a href="{% url 'finance:transaction_create' %}" class="btn btn-primary btn-sm">Nova Transação</a>
            </div>
        </div>
    </div>

    <!-- Gastos por Categoria -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Gastos por Categoria (30 dias)</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="200"></canvas>
                <div class="mt-3">
                    <table class="table table-sm">
                        <tbody>
                            {% for item in expenses_by_category %}
                            <tr>
                                <td>{{ item.get_category_display }}</td>
                                <td class="text-end">R$ {{ item.total|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center">Nenhum gasto registrado</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Orçamentos -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Orçamentos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th class="text-end">Orçado</th>
                                <th class="text-end">Gasto</th>
                                <th class="text-end">Disponível</th>
                                <th class="text-end">%</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for budget in budgets %}
                            <tr>
                                <td>{{ budget.get_category_display }}</td>
                                <td class="text-end">R$ {{ budget.amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">R$ {{ budget.spent_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">R$ {{ budget.remaining_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if budget.percentage_spent > 100 %}bg-danger{% elif budget.percentage_spent > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ budget.percentage_spent }}%;" 
                                             aria-valuenow="{{ budget.percentage_spent }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ budget.percentage_spent|floatformat:0 }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'finance:budget_edit' budget.id %}" class="btn btn-sm btn-outline-secondary">Editar</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">Nenhum orçamento definido</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="{% url 'finance:budget_list' %}" class="btn btn-outline-primary btn-sm">Ver todos</a>
                <a href="{% url 'finance:budget_create' %}" class="btn btn-primary btn-sm">Novo Orçamento</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Gráfico de Gastos por Categoria
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = [
        {% for item in expenses_by_category %}
            '{{ item.get_category_display }}',
        {% endfor %}
    ];
    const categoryData = [
        {% for item in expenses_by_category %}
            {{ item.total }},
        {% endfor %}
    ];
    
    const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#8AC24A', '#607D8B', '#E91E63', '#9C27B0'
                ],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
</script>
{% endblock %}